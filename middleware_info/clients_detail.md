# 客户端应用详解

## 客户端应用的本质

### 核心概念

OpenClaw 的架构是 **Client-Server 模式**：

```
┌─────────────────────────────────────────────────────────────┐
│                    Gateway 服务 (核心)                        │
│         运行在服务器/本地，处理所有业务逻辑                      │
│                                                              │
│   - AI Agent 运行时                                          │
│   - 消息渠道连接 (WhatsApp, Telegram, etc.)                    │
│   - 会话管理                                                  │
│   - 工具调用执行                                              │
└─────────────────────────┬───────────────────────────────────┘
                          │
                          │ WebSocket / HTTP
                          │
        ┌─────────────────┼─────────────────┐
        │                 │                 │
        ▼                 ▼                 ▼
   ┌─────────┐      ┌─────────┐      ┌─────────┐
   │ macOS   │      │   iOS   │      │ Android │
   │   App   │      │   App   │      │   App   │
   └─────────┘      └─────────┘      └─────────┘
```

**Gateway 是"大脑"**，客户端应用是**控制和交互界面**。

---

## 各客户端的作用

### 1. macOS 应用 (`apps/macos/`)

**定位**: OpenClaw 的**主要桌面控制中心**

**核心功能**:
| 功能 | 说明 |
|------|------|
| Gateway 管理 | 启动/停止/监控本地 Gateway 服务 |
| 菜单栏集成 | 在 Mac 菜单栏显示状态和快捷操作 |
| 系统托盘 | 后台运行，快速访问 |
| 语音唤醒 | 通过 Siri 或快捷键激活 AI 助手 |
| 原生通知 | macOS 通知中心集成 |
| 配对管理 | 审批新设备/节点的连接请求 |

**实际应用场景**:

```
场景 1: 开发者日常使用
─────────────────────────
用户坐在 Mac 电脑前：
1. macOS App 在菜单栏运行，Gateway 在后台服务
2. 用户收到 WhatsApp 消息 → Gateway 处理 → AI 自动回复
3. 用户想查看状态 → 点击菜单栏图标 → 看到 Gateway 运行状态
4. 用户想临时关闭 → 点击菜单 → "暂停自动回复"

场景 2: 语音助手
─────────────────────────
用户对着 Mac 说 "Hey OpenClaw"：
1. macOS App 检测到语音唤醒
2. 录制用户问题
3. 发送给 Gateway → AI 处理 → 返回答案
4. 通过 TTS 语音播放回答

场景 3: 远程访问审批
─────────────────────────
用户在 iPhone 上尝试连接家里的 Gateway：
1. iOS App 发起配对请求
2. macOS App 弹出通知："新设备请求连接"
3. 用户点击"允许"→ 配对完成
4. iPhone 现在可以控制 Gateway
```

---

### 2. iOS 应用 (`apps/ios/`)

**定位**: **移动端控制和远程访问**

**核心功能**:
| 功能 | 说明 |
|------|------|
| 远程 Gateway 连接 | 连接家中/服务器的 Gateway |
| 聊天界面 | 与 AI 进行对话 |
| 语音对话 | Talk Mode 语音交互 |
| 设备能力 | 相机、位置、通讯录等原生能力 |
| 推送通知 | 接收消息和事件通知 |

**实际应用场景**:

```
场景 1: 出门在外控制家中 AI
─────────────────────────
用户在公司或旅行中：
1. iPhone 打开 OpenClaw App
2. 连接到家中的 Gateway（通过 Tailscale 或公网）
3. 查看 AI 助手的状态、会话历史
4. 发送指令让 AI 执行任务

场景 2: 移动语音助手
─────────────────────────
用户在开车或走路时：
1. 打开 App → 语音模式
2. 对着手机说 "帮我查一下今天的日程"
3. AI 通过 Gateway 查询 → 语音播报结果

场景 3: 拍照识别
─────────────────────────
用户看到某个物品：
1. 打开 App → 相机功能
2. 拍照 → 发送给 Gateway
3. AI 分析图片 → 返回识别结果

场景 4: 位置感知
─────────────────────────
用户回到家：
1. iOS App 检测到位置变化
2. 通知 Gateway 用户已到家
3. Gateway 切换到"在家模式"（如：更积极的自动回复）
```

---

### 3. Android 应用 (`apps/android/`)

**定位**: 与 iOS 类似，面向 Android 用户

**实际应用场景**: 与 iOS 类似，用于 Android 手机的远程控制和移动访问。

---

### 4. Web UI (`ui/`)

**定位**: **通用访问界面**，可在任何浏览器中使用

**实际应用场景**:

```
场景: 在任意设备上快速访问
─────────────────────────
1. 用户在朋友的电脑上，打开浏览器
2. 访问 Gateway 的 Web UI（如 http://localhost:18789）
3. 查看状态、配置、聊天
4. 无需安装任何应用
```

---

## 为什么需要多个客户端？

### 1. 不同场景的需求

| 场景             | 最适合的客户端      |
| ---------------- | ------------------- |
| Mac 桌面日常工作 | macOS App           |
| 外出移动使用     | iOS/Android App     |
| 快速临时访问     | Web UI              |
| 服务器部署       | 仅 Gateway + Web UI |

### 2. 原生能力的利用

| 能力      | macOS | iOS | Android | Web  |
| --------- | ----- | --- | ------- | ---- |
| 语音唤醒  | ✅    | ✅  | ✅      | ❌   |
| 推送通知  | ✅    | ✅  | ✅      | ❌   |
| 相机/相册 | ✅    | ✅  | ✅      | 部分 |
| 位置服务  | ✅    | ✅  | ✅      | ❌   |
| 后台运行  | ✅    | ✅  | ✅      | ❌   |
| 系统托盘  | ✅    | ❌  | ❌      | ❌   |

### 3. 用户体验差异

```
macOS App:
- 常驻菜单栏，一键访问
- 与 macOS 系统深度集成
- 适合长时间运行的场景

iOS/Android App:
- 移动优先设计
- 触控交互
- 适合短时间快速操作

Web UI:
- 无需安装
- 跨平台
- 适合配置和管理任务
```

---

## 典型使用场景汇总

### 场景 1: 个人 AI 助手

```
用户设备: Mac + iPhone
部署方式: Gateway 运行在 Mac 上

日常使用:
- Mac 开机 → macOS App 自动启动 Gateway
- 用户通过 WhatsApp/Telegram 与 AI 对话
- 出门时用 iPhone App 检查状态或发送指令
- 回家后 Mac 继续处理
```

### 场景 2: 家庭智能中心

```
用户设备: Mac mini (家庭服务器) + 全家手机
部署方式: Gateway 运行在 Mac mini 上

日常使用:
- Mac mini 作为家庭 AI 服务器 24/7 运行
- 家庭成员的 WhatsApp/Telegram 都连接到这里
- 每个人可以用自己的手机 App 远程控制
- Mac mini 的 macOS App 管理配对和审批
```

### 场景 3: 远程服务器部署

```
用户设备: 云服务器 + 任意设备
部署方式: Gateway 运行在云服务器上

日常使用:
- 服务器运行 Gateway（无 GUI）
- 用户通过 Web UI 或手机 App 远程访问
- 适合需要 24/7 高可用的场景
```

---

## 客户端与服务端的关系

### 连接方式

```
┌──────────────────────────────────────────────────────────────┐
│                     Gateway 服务端                            │
│                                                              │
│   监听端口: 18789 (可配置)                                    │
│   协议: WebSocket + HTTP                                      │
│   认证: TLS Pinning / Token / Pairing                        │
│                                                              │
└───────────────────────────┬──────────────────────────────────┘
                            │
         ┌──────────────────┼──────────────────┐
         │                  │                  │
         ▼                  ▼                  ▼
    ┌─────────┐       ┌─────────┐       ┌─────────┐
    │ 本地连接 │       │ 局域网   │       │ 远程连接 │
    │ loopback│       │ LAN     │       │ Tailscale│
    └─────────┘       └─────────┘       └─────────┘
         │                  │                  │
         ▼                  ▼                  ▼
    ┌─────────┐       ┌─────────┐       ┌─────────┐
    │ macOS   │       │ 手机App │       │ 手机App │
    │ App     │       │ (同一网络)│       │ (远程)  │
    └─────────┘       └─────────┘       └─────────┘
```

### 配对流程

```
1. 新设备发起配对请求
       │
       ▼
2. Gateway 生成配对码
       │
       ▼
3. 已授权设备收到通知
       │
       ▼
4. 用户在已授权设备上审批
       │
       ▼
5. 新设备获得访问令牌
       │
       ▼
6. 配对完成，可以正常使用
```

---

## 各客户端的代码目录

### macOS 应用

```
apps/macos/
├── Sources/
│   ├── OpenClaw/           # 主应用 UI
│   ├── OpenClawKit/        # 共享功能库
│   ├── OpenClawProtocol/   # Gateway 协议
│   ├── OpenClawDiscovery/  # Gateway 发现
│   └── OpenClawIPC/        # 进程间通信
└── Tests/
    └── OpenClawIPCTests/
```

### iOS 应用

```
apps/ios/
├── Sources/
│   ├── OpenClawApp.swift   # 应用入口
│   ├── Chat/               # 聊天模块
│   ├── Voice/              # 语音模块
│   ├── Gateway/            # Gateway 连接
│   └── Services/           # 原生服务
└── Tests/
```

### Android 应用

```
apps/android/
├── app/src/main/
│   ├── java/ai/openclaw/android/
│   │   ├── ui/             # UI 组件
│   │   ├── viewmodel/      # ViewModel
│   │   └── service/        # 服务层
│   └── AndroidManifest.xml
└── build.gradle.kts
```

### Web UI

```
ui/
├── src/
│   ├── main.ts             # 入口
│   ├── ui/
│   │   ├── app.ts          # 主应用
│   │   ├── controllers/    # 控制器
│   │   └── views/          # 视图
│   └── gateway.ts          # Gateway 连接
└── package.json
```

---

## 总结

| 客户端          | 角色定位                    | 主要场景                             |
| --------------- | --------------------------- | ------------------------------------ |
| **macOS App**   | 本地控制中心 + Gateway 宿主 | Mac 用户的主要界面，管理本地 Gateway |
| **iOS App**     | 移动远程控制                | iPhone 用户外出时访问和控制          |
| **Android App** | 移动远程控制                | Android 用户外出时访问和控制         |
| **Web UI**      | 通用访问界面                | 任意设备的浏览器访问                 |

**核心理解**:

- Gateway 是**服务端**，负责所有业务逻辑
- 客户端是**界面层**，提供用户交互入口
- 多个客户端可以同时连接同一个 Gateway

---

## 客户端类型说明

### 核心概念：Web UI 也是客户端

**重要**: Web UI 本身就是一个客户端！所有连接到 Gateway 的界面都是客户端。

```
所有客户端类型：
├── Web UI (浏览器客户端)
├── macOS App (原生桌面客户端)
├── iOS App (原生移动客户端)
└── Android App (原生移动客户端)
```

### 客户端的正确定义

**"客户端" = 任何连接到 Gateway 的界面**

```
┌─────────────────────────────────────────────────────────────┐
│                    Gateway 服务端                            │
│              (运行在服务器/本地)                              │
└────────────────────────┬────────────────────────────────────┘
                         │
         ┌───────────────┼───────────────┬──────────────┐
         │               │               │              │
         ▼               ▼               ▼              ▼
    ┌────────┐      ┌────────┐     ┌────────┐    ┌────────┐
    │ Web UI │      │ macOS  │     │  iOS   │    │Android │
    │(浏览器) │      │  App   │     │  App   │    │  App   │
    └────────┘      └────────┘     └────────┘    └────────┘
     客户端1          客户端2        客户端3       客户端4
```

---

## Web UI 详解

### Web UI 是什么？

**Web UI** (`ui/`) 是一个**基于浏览器的客户端**：

| 属性            | 说明                                           |
| --------------- | ---------------------------------------------- |
| 📍 **运行位置** | 在浏览器中运行                                 |
| 🔗 **连接方式** | 通过 WebSocket 连接到 Gateway                  |
| 💻 **访问地址** | `http://localhost:18789` 或 Gateway 的 IP 地址 |
| 🎯 **主要用途** | 配置管理、状态查看、聊天交互                   |
| 📦 **安装要求** | 无需安装，打开浏览器即可                       |

### 启动 Web UI

```bash
# 方式 1: 开发模式
pnpm ui:dev
# 浏览器打开 http://localhost:5173

# 方式 2: 访问 Gateway 内置的 Web UI
# 浏览器打开 http://localhost:18789
```

---

## 各客户端对比

### 功能对比表

| 特性         | Web UI        | macOS App  | iOS App     | Android App    |
| ------------ | ------------- | ---------- | ----------- | -------------- |
| **运行环境** | 浏览器        | macOS 系统 | iPhone/iPad | Android 手机   |
| **安装方式** | 无需安装      | 安装 .app  | App Store   | APK/Play Store |
| **访问方式** | 打开网址      | 启动应用   | 启动应用    | 启动应用       |
| **原生能力** | 有限          | 完整       | 完整        | 完整           |
| **语音唤醒** | ❌            | ✅         | ✅          | ✅             |
| **推送通知** | ❌            | ✅         | ✅          | ✅             |
| **相机调用** | 部分          | ✅         | ✅          | ✅             |
| **位置服务** | ❌            | ✅         | ✅          | ✅             |
| **后台运行** | ❌            | ✅         | ✅          | ✅             |
| **系统托盘** | ❌            | ✅         | ❌          | ❌             |
| **适用场景** | 快速访问/配置 | 桌面主力   | 移动使用    | 移动使用       |

---

## 实际使用场景对比

### 场景 1: 在自己的 Mac 上

```
选项 A: 使用 Web UI
─────────────────────
1. 启动 Gateway (后台运行)
2. 打开浏览器 → http://localhost:18789
3. 在网页中操作
4. 适合：快速查看状态、修改配置

选项 B: 使用 macOS App
─────────────────────
1. 启动 macOS App (菜单栏图标)
2. macOS App 自动启动 Gateway
3. 点击菜单栏图标 → 原生界面
4. 可以使用语音唤醒等原生功能
5. 适合：日常主力使用
```

### 场景 2: 在朋友的电脑上

```
只能使用 Web UI:
─────────────────────
1. 打开浏览器
2. 输入你家 Gateway 的地址 (如通过 Tailscale)
3. 在网页中查看状态、发送消息
4. 无需安装任何软件
5. 适合：临时访问
```

### 场景 3: 在手机上

```
选项 A: 使用手机浏览器 (Web UI)
─────────────────────
1. 手机浏览器打开 Gateway 地址
2. 在网页中操作
3. 功能有限（无法调用相机、位置等）
4. 适合：临时查看

选项 B: 使用 iOS/Android App
─────────────────────
1. 打开原生 App
2. 可以使用相机拍照识别
3. 可以使用位置服务
4. 可以接收推送通知
5. 体验更好
6. 适合：日常使用
```

---

## 客户端 vs 消息平台

### 重要区分

```
┌─────────────────────────────────────────────────────────────┐
│                   消息平台 (非客户端)                         │
│  WhatsApp, Telegram, Discord, Slack...                      │
│  用户在这些平台发消息，不需要安装 OpenClaw                     │
└────────────────────────┬────────────────────────────────────┘
                         │ 消息接入
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                    Gateway 服务端                            │
│  - 接收消息平台的消息                                         │
│  - 接收客户端的请求                                           │
│  - 处理所有业务逻辑                                           │
└────────────────────────┬────────────────────────────────────┘
                         │ 客户端连接
         ┌───────────────┼───────────────┬──────────────┐
         │               │               │              │
         ▼               ▼               ▼              ▼
    ┌────────┐      ┌────────┐     ┌────────┐    ┌────────┐
    │ Web UI │      │ macOS  │     │  iOS   │    │Android │
    │        │      │  App   │     │  App   │    │  App   │
    │ 浏览器  │      │ 原生应用│     │ 原生应用│    │ 原生应用│
    └────────┘      └────────┘     └────────┘    └────────┘

    这些都是 OpenClaw 的客户端
    用于控制和管理 Gateway
```

### 两者的区别

| 对比项       | OpenClaw 客户端                         | 消息平台                              |
| ------------ | --------------------------------------- | ------------------------------------- |
| **是什么**   | Web UI、macOS App、iOS App、Android App | WhatsApp、Telegram、Discord、Slack 等 |
| **作用**     | 控制和管理 Gateway                      | 作为消息来源，用户通过它们与 AI 对话  |
| **需要安装** | 是（除了 Web UI）                       | 用户已有，无需额外安装                |
| **连接方式** | 直接连接 Gateway                        | Gateway 主动连接消息平台 API          |
| **用户**     | OpenClaw 管理员/使用者                  | 任何与 AI 对话的人                    |

### 示例说明

```
场景: 家庭 AI 助手

家庭成员 A 的 WhatsApp ─┐
家庭成员 B 的 Telegram ─┤
家庭成员 C 的 Discord  ─┼──→ Gateway ──→ AI Agent
                        │         ↑
                        │         │ 管理和控制
                        │         │
                        └─────────┤
                                  │
                            ┌─────┴─────┐
                            │  macOS    │
                            │   App     │
                            │ (管理员)   │
                            └───────────┘

说明:
- 家庭成员通过 WhatsApp/Telegram/Discord 与 AI 对话
  (他们不需要安装 OpenClaw 客户端)

- 管理员使用 macOS App 来:
  - 查看 Gateway 状态
  - 修改配置
  - 审批新设备连接
  - 查看会话历史
```

---

## 常见误解澄清

### ❌ 错误理解

1. **误解**: "客户端是外部设备，Web UI 是内部界面"
   - **正确**: 客户端包括 Web UI，都是连接到 Gateway 的界面

2. **误解**: "WhatsApp/Telegram 是 OpenClaw 的客户端"
   - **正确**: 它们是消息平台，不是 OpenClaw 客户端

3. **误解**: "Web UI 功能比原生 App 弱，不算真正的客户端"
   - **正确**: Web UI 是完整的客户端，只是原生能力受限于浏览器

### ✅ 正确理解

| 概念                | 说明                                                           |
| ------------------- | -------------------------------------------------------------- |
| **OpenClaw 客户端** | Web UI、macOS App、iOS App、Android App（都是）                |
| **消息平台**        | WhatsApp、Telegram 等（不是 OpenClaw 客户端）                  |
| **外部设备**        | 运行客户端的远程设备（如：办公室的 iPhone 连接家里的 Gateway） |

---

## 数据流向详解

### 完整数据流图

```
┌─────────────────────────────────────────────────────────────────┐
│                        客户端层                                   │
│                                                                  │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐                  │
│  │ macOS    │    │   iOS    │    │ Android  │                  │
│  │          │    │          │    │          │                  │
│  │ - 菜单栏  │    │ - 相机   │    │ - 相机   │                  │
│  │ - 通知   │    │ - 位置   │    │ - 位置   │                  │
│  │ - 语音   │    │ - 通讯录 │    │ - 通讯录 │                  │
│  └────┬─────┘    └────┬─────┘    └────┬─────┘                  │
│       │               │               │                         │
└───────┼───────────────┼───────────────┼─────────────────────────┘
        │               │               │
        │ WebSocket     │ WebSocket     │ WebSocket
        │               │               │
        └───────────────┴───────────────┘
                        │
┌───────────────────────▼─────────────────────────────────────────┐
│                    Gateway 网关层                                │
│                                                                  │
│  ┌────────────────────────────────────────────────────────┐    │
│  │  请求分发 (server-methods.ts)                           │    │
│  │  - 验证客户端身份                                        │    │
│  │  - 解析请求参数                                          │    │
│  │  - 路由到对应 Handler                                    │    │
│  └────────────────────────┬───────────────────────────────┘    │
│                           │                                     │
└───────────────────────────┼─────────────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────────────┐
│                    Agent 执行层                                  │
│                                                                  │
│  ┌──────────────────────────────────────────────────────┐      │
│  │  Agent Runtime (src/agents/)                         │      │
│  │  1. 接收用户指令                                      │      │
│  │  2. 解析意图                                          │      │
│  │  3. 调用 AI 模型 (OpenAI/Anthropic/etc.)             │      │
│  │  4. 执行工具调用 (read_file, execute_command, etc.)  │      │
│  │  5. 生成响应                                          │      │
│  └──────────────────────────────────────────────────────┘      │
│                                                                  │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            │ 响应返回
                            │
┌───────────────────────────▼─────────────────────────────────────┐
│                    Gateway 网关层                                │
│  - 格式化响应                                                    │
│  - 推送到对应客户端                                              │
└───────────────────────────┬─────────────────────────────────────┘
                            │
        ┌───────────────────┴───────────────┐
        │               │               │
        ▼               ▼               ▼
   ┌──────────┐    ┌──────────┐    ┌──────────┐
   │ macOS    │    │   iOS    │    │ Android  │
   │ 显示结果  │    │ 显示结果  │    │ 显示结果  │
   └──────────┘    └──────────┘    └──────────┘
```

---

## 具体数据流示例

### 示例 1: iOS 拍照识别流程

```
1. 用户操作 (iOS App)
   ├─ 用户点击相机按钮
   ├─ iOS 调用原生相机 API
   └─ 拍照完成，获得图片数据

2. 数据发送 (iOS → Gateway)
   ├─ iOS App 将图片编码 (Base64/二进制)
   ├─ 通过 WebSocket 发送到 Gateway
   └─ 请求: {
         method: "agent",
         params: {
           message: "这是什么？",
           images: [<图片数据>]
         }
       }

3. Gateway 处理
   ├─ 接收请求
   ├─ 验证客户端权限
   ├─ 路由到 Agent Handler
   └─ 调用 Agent 系统

4. Agent 执行
   ├─ 接收图片 + 问题
   ├─ 调用 AI 模型 (如 GPT-4 Vision)
   ├─ AI 分析图片
   └─ 生成回答: "这是一只猫"

5. 响应返回 (Gateway → iOS)
   ├─ Gateway 格式化响应
   ├─ 通过 WebSocket 推送到 iOS
   └─ 响应: {
         ok: true,
         result: "这是一只猫"
       }

6. 显示结果 (iOS App)
   ├─ iOS App 接收响应
   ├─ 更新 UI
   └─ 显示: "这是一只猫"
```

### 示例 2: macOS 语音唤醒流程

```
1. 用户操作 (macOS)
   ├─ 用户说 "Hey OpenClaw"
   ├─ macOS App 检测到唤醒词
   └─ 开始录音: "今天天气怎么样？"

2. 数据发送 (macOS → Gateway)
   ├─ macOS App 将语音转文字 (或发送音频)
   ├─ 通过 WebSocket 发送到 Gateway
   └─ 请求: {
         method: "agent",
         params: {
           message: "今天天气怎么样？"
         }
       }

3. Gateway 处理
   ├─ 接收请求
   ├─ 路由到 Agent Handler
   └─ 调用 Agent 系统

4. Agent 执行
   ├─ 接收问题
   ├─ 调用 AI 模型
   ├─ AI 可能调用天气 API 工具
   └─ 生成回答: "今天北京晴天，温度 20°C"

5. 响应返回 (Gateway → macOS)
   ├─ Gateway 格式化响应
   ├─ 通过 WebSocket 推送到 macOS
   └─ 响应: {
         ok: true,
         result: "今天北京晴天，温度 20°C"
       }

6. 显示结果 (macOS App)
   ├─ macOS App 接收响应
   ├─ 调用 TTS 语音播报
   └─ 语音播放: "今天北京晴天，温度 20°C"
```

### 示例 3: 多客户端同时使用

```
场景: 用户同时使用 Mac 和 iPhone

┌──────────┐                    ┌──────────┐
│  macOS   │◄───WebSocket 1────►│          │
│   App    │                    │          │
└──────────┘                    │          │
                                │ Gateway  │
┌──────────┐                    │          │
│   iOS    │◄───WebSocket 2────►│          │
│   App    │                    │          │
└──────────┘                    └─────┬────┘
                                      │
                                      ▼
                                ┌──────────┐
                                │  Agent   │
                                └──────────┘

特点:
- 两个客户端共享同一个 Agent 会话
- 在 Mac 上发起的对话，可以在 iPhone 上看到
- 会话历史同步
- 实时状态更新
```

---

## 职责划分

### 客户端的职责

✅ **负责**:

- 提供用户界面
- 调用原生能力（相机、位置、通讯录等）
- 采集用户输入（文字、语音、图片）
- 显示 AI 响应
- 本地状态管理（UI 状态）

❌ **不负责**:

- AI 推理计算
- 直接调用 AI 模型 API
- 业务逻辑处理
- 会话持久化

### Gateway 的职责

✅ **负责**:

- 接收所有客户端请求
- 身份验证和权限控制
- 请求路由和分发
- 管理与 Agent 的通信
- 响应格式化和推送
- 连接管理（WebSocket）

### Agent 的职责

✅ **负责**:

- 执行 AI 推理
- 调用 AI 模型 API
- 执行工具调用（文件操作、命令执行等）
- 管理会话状态
- 生成最终响应
- 技能和工具管理

---

## 通信协议

### WebSocket 消息格式

**请求格式**:

```json
{
  "id": 1,
  "method": "agent",
  "params": {
    "message": "用户消息",
    "images": ["base64图片数据"],
    "agentId": "default"
  }
}
```

**响应格式**:

```json
{
  "id": 1,
  "ok": true,
  "result": {
    "message": "AI 回复",
    "toolCalls": [...]
  }
}
```

**事件推送**:

```json
{
  "event": "agent",
  "data": {
    "type": "text",
    "content": "正在思考..."
  }
}
```

---

## 架构优势

### 1. 客户端轻量化

- 只需要处理 UI 和原生能力
- 无需集成复杂的 AI SDK
- 应用体积小，启动快

### 2. 逻辑集中化

- 所有 AI 逻辑在 Gateway/Agent 层
- 便于维护和升级
- 统一的业务规则

### 3. 多端一致性

- 不同客户端共享同一套后端逻辑
- 行为一致，体验统一
- 减少重复开发

### 4. 易于扩展

- 新增客户端只需要实现 Gateway 协议
- 无需重新实现业务逻辑
- 支持第三方客户端接入

### 5. 灵活部署

- Gateway 可以运行在本地或远程
- 支持多种连接方式（本地/局域网/远程）
- 适应不同使用场景

---

_文档生成时间: 2026-02-13_
